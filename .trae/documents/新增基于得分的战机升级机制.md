**目标**

* 基于总得分实现战机升级：每级所需得分按倍数增长，设最高等级。

* 升级即时回满血、提升最高血量和其他属性，触发闪烁与升级音效。

* UI调整：武器等级显示到左上角武器名字旁；玩家机体上方原本显示的武器等级改为战机等级。

* 图鉴显示战机“最高等级”的数值（含派生后的最终属性）。

* 将“升级能提升哪些属性”做成可配置，放到现有配置体系中（项目不存在 `play.ts`，采用 `game/config/player.ts`）。

**配置设计**

* 在 `game/config/player.ts` 增加 `leveling` 配置：

  * `maxLevel`: 最高等级（默认 10）。

  * `baseScoreForLevel1`: 升到 2 级的基础得分（例如 1,000）。

  * `scoreGrowthFactor`: 每级需求乘子，设为 `2`（翻倍）。

  * `bonusesPerLevel`: 每升一级的增量（可正/百分比）：

    * `maxHpFlat`: 每级 +N 最大生命（如 +15）。

    * `maxShieldFlat`: 每级 +N 护盾上限（如 +10）。

    * `defensePct`: 每级 +M% 伤害减免（如 +3%）。

    * `fireRatePct`: 每级 +X% 射速（如 +2%）。

    * `damagePct`: 每级 +Y% 武器伤害（如 +2%）。

  * 说明：全部参数可调，以满足不同平衡需求。

**引擎逻辑**

* 在 `game/GameEngine.ts`：

  * 新增字段：`playerLevel`、`nextLevelScore`。

  * 在加分路径或 `onScoreChange(score)` 中调用 `checkAndApplyLevelUp()`：

    * 若 `score >= nextLevelScore` 且 `playerLevel < maxLevel`，则：

      * `playerLevel += 1`；

      * `nextLevelScore *= scoreGrowthFactor`；

      * 应用 `bonusesPerLevel`：

        * `player.maxHp += maxHpFlat`，并 `player.hp = player.maxHp`；

        * `getShieldCap()` 依赖的基础值增加 `maxShieldFlat`，并令当前 `shield = 新上限`；

        * 记录/应用 `defensePct` 到伤害计算；

        * 将 `fireRatePct`、`damagePct` 传入/叠加到射击与伤害管线（武器/子弹系统读取倍率）。

      * 视觉/音效：设置 `player.hitFlashUntil = now + flashDuration`；调用音效 `playLevelUp()`。

  * 在 `takeDamage(amount)` 中注入伤害减免：`effective = amount * (1 - totalDefensePct)`。

**音效与特效**

* 在 `game/systems/AudioSystem.ts`：

  * 新增 `playLevelUp()` 并绑定升级音效资源路径（参考现有 `playVictory()` 等写法）。

* 闪烁：复用现有命中闪烁机制（`player.hitFlashUntil`；`game/systems/RenderSystem.ts` 渲染覆盖），升级时触发数次短闪（可通过延长时间或调用多次设置实现）。

**UI调整**

* 顶部左侧武器名字旁显示武器等级：修改 `components/GameUI.tsx`，在武器名称旁追加 `Lv.{weaponLevel}`。

* 机体上方等级徽标：修改 `game/systems/RenderSystem.ts`，原来绘制 `LV.{weaponLevel}` 的位置改为绘制战机等级 `LV.{playerLevel}`。

* 其他 UI 文案保持一致（`SCORE`、`LEVEL` 为关卡/阶段，不冲突）。

**图鉴更新**

* 在 `components/gallery/FighterDetail.tsx`：

  * 显示“最高等级”字段（来源 `leveling.maxLevel`）。

  * 显示最大等级下的派生属性（`maxHp`、`maxShield`、`defensePct`、`fireRatePct`、`damagePct` 合并增益后结果）。

* 数据来源：读取 `game/config/player.ts` 的 `leveling`，按 `maxLevel` 计算总加成并展示。

**数据与平衡**

* 默认数值（可在配置里改）：

  * `maxLevel=10`，`baseScoreForLevel1=1000`，`scoreGrowthFactor=2`。

  * 每级：`maxHp +15`、`maxShield +10`、`defense +3%`、`fireRate +2%`、`damage +2%`。

* 说明：翻倍得分阈值会让中后期升级变缓；若节奏偏慢，可降低基础值或改为 1.75 倍。

**文件改动一览**

* `game/config/player.ts`：新增 `leveling` 配置结构与默认数值。

* `game/GameEngine.ts`：新增 `playerLevel`/`nextLevelScore`，实现 `checkAndApplyLevelUp()` 与伤害减免应用。

* `game/systems/AudioSystem.ts`：新增 `playLevelUp()`。

* `game/systems/RenderSystem.ts`：玩家上方等级显示改为战机等级。

* `components/GameUI.tsx`：武器名称旁显示武器等级。

* `components/gallery/FighterDetail.tsx`：展示最高等级与派生后的最终属性。

* 如需：在 `types/index.ts` 增加 `playerLevel`、`defensePct` 等字段声明。

* 把本次新增和修改的玩法模块和数值等，更新到 GAME\_BALANCE\_DESIGN 文档中。

**验证方案**

* 通过调试分数（或快速击杀）触发多次升级，观察：

  * 得分阈值按倍数增长；

  * 升级后血量与护盾回满，属性提升生效；

  * 玩家机体闪烁与升级音效播放；

  * UI位置与文案符合：武器等级在左上角名字旁，机体上方显示战机等级；

  * 图鉴显示最高等级与最终属性。

